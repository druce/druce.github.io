<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FinTwit Network Browser</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style type="text/css">
	#graphcontainer {
	  max-width: 1000px;
	  height: 800px;
	  margin: auto;
	}
	#popover {
		font-family: Arial, Helvetica, sans-serif;
		font-size: 12px;
	}
</style></head>
<body>
	<div class="container-fluid">
			<div class="row">
				<div class="col-9" id="graphcontainer"></div>
				<div class="col-3">
					<div class="row">
					&nbsp; <br />
					<button class="btn btn-primary btn-sm" type="button" id="button1">Force Layout</button> &nbsp;
					<button class="btn btn-primary btn-sm" type="button" id="button2">Reset</button>
					</div>
					<div class="row">
						<div id="popover">
										</div>
					</div>	
					<div class="row">
						<form class="row form-inline">
						<div class="form-group mx-sm-2 mb-2">
							<input type="text" class="form-control" id="searchinput" placeholder="Account/Name">
							<button class="btn btn-primary btn-sm" id="searchbutton">Search</button>
						</div>
						</form>
						<div id="results">

						</div>
					</div>
				</div>
			</div>
	</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="sigma.require.js"></script>
<script src="sigma.js/plugins/sigma.parsers.json/sigma.parsers.json.js"></script>
<script src="sigma.js/plugins/sigma.layout.forceAtlas2/worker.js"></script>
<script src="sigma.js/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>

<script>
	var globalsigma;
	var globalSearchResults= [];
	var globalSearchSaved= [];
	var globalEdgeSaved= [];

	function doForce() {
		window.globalsigma.startForceAtlas2({worker: true, barnesHutOptimize: false});
		setTimeout(function() {window.globalsigma.stopForceAtlas2(); }, 5000);
	}
	document.getElementById("button1").onclick=doForce;

	function doReinit() {
		// clear the graph nodes and edges
		s=window.globalsigma;
		s.graph.clear();
	    // remove any methods you've attached to s.
    	s.graph.kill();
		var g = document.querySelector('#graphcontainer');
	    var p = g.parentNode;
	    p.removeChild(g);
	    var c = document.createElement('div');
		c.setAttribute('id', 'graphcontainer');
		c.setAttribute('class', 'col-9');
	    p.prepend(c);		
		sigma.parsers.json("initial.json",
			{container: 'graphcontainer'},
			reinit
		);
	}
	document.getElementById("button2").onclick=doReinit;

	function doSearch(event) {
		event.preventDefault();
		resetSearch();
		retstr='';
		str = $('#searchinput').val();
		if (2 >= str.length) {
			$('#results').html("<i>You must search for a name with a minimum of 3 letters.</i>");
			return;
		} else {
			$('#results').html("");
		}
		globalSearchResults=[];
		str = str.toLowerCase();
		re = RegExp(str);
		nodes = globalsigma.graph.nodes()
		for (var i = 0; i < nodes.length; i++) {
			if (re.test(nodes[i].label.toLowerCase())) {
				globalSearchResults.push(nodes[i]);
				saveobj = {id: i, size: nodes[i].size, color: nodes[i].color};
				globalSearchSaved.push(saveobj);
			}
		}
		for (var i = 0; i < globalSearchResults.length; i++) {
			mynode = globalSearchResults[i];
			mynode.size=50;
			mynode.color="#000000";
		}		
		globalsigma.refresh()
	}
	document.getElementById('searchbutton').onclick=doSearch;

	function resetSearch() {
		for (i = 0; i < globalSearchSaved.length; i++) {
			savedvals = globalSearchSaved[i];
			mynode = globalsigma.graph.nodes()[savedvals.id];
			mynode.size = savedvals.size;
			mynode.color=savedvals.color
		}
		globalsigma.refresh()
		globalSearchSaved=[];
	}

	function edgesText(node) {
		node_id = node.id;
		follows = {};
		followed_by = {};
		follows_str='';
		followed_by_str='';
		both_str = '';
		
		alledges = globalsigma.graph.edges();
		for (i = 0; i < alledges.length; i++) {
			e = alledges[i];
			if (e.source == node_id)
				follows[e.target] = 1 
			if (e.target==node_id)
				followed_by[e.source] = 1 
		}
		var keys = Object.keys(followed_by);
		for (i = 0; i < keys.length; i++) {
			followed_by_id = followed_by[keys[i]];
			if(followed_by_id in follows)
				both_str += followed_by_id;
			else
				followed_by_str += followed_by_id;
		}
		for (i = 0; i < sources.length; i++) {
			e = sources[i];
			e.color='#0000cc';
			e.size=2;
			e["read_cam0:size"]=2;			
		}

		globalsigma.refresh();
	}

	function highlightEdges(node) {
		node_id = node.id;
		sources = [];
		targets = [];
		both = [];
		alledges = globalsigma.graph.edges();
		for (i = 0; i < alledges.length; i++) {
			e = alledges[i];
			if (e.source == node_id)
				sources.push(e)
			if (e.target==node_id)
				targets.push(e)
		}
		for (i = 0; i < both.length; i++) {
			e = both[i];
			e.color='#cc0000';
			e.size=2;
			e["read_cam0:size"]=2;			
		}
		for (i = 0; i < targets.length; i++) {
			e = targets[i];
			e.color='#00cc00';
			e.size=2;
			e["read_cam0:size"]=2;			
		}
		for (i = 0; i < sources.length; i++) {
			e = sources[i];
			e.color='#0000cc';
			e.size=2;
			e["read_cam0:size"]=2;			
		}

		globalsigma.refresh();
	}

	function reinit (s) {
		window.globalsigma=s;
		s.settings('verbose', true);
		s.settings('defaultEdgeColor', '#ccc');
//		s.settings('defaultNodeColor', '#903');
		s.settings('defaultLabelSize', '10');
		s.settings('maxNodeSize', 4);
		s.settings('minEdgeSize', 1);
		s.settings('maxEdgeSize', 1);
		s.settings('labelThreshold', 999999);
//		s.settings('defaultLabelColor', '#900');
//		s.settings('defaultLabelBGColor', '#ddd');
		s.settings('drawNodes', true);
		s.settings('drawEdges', true);
		s.settings('batchEdgesDrawing', true);
		s.settings('labelColor', 'node');
		s.settings('edgeColor', '#000000');
		s.settings('zoomMin', 1);
		s.settings('zoomMax', 1);
				
		s.bind('clickNode', function(event) { console.log(event); } );
		s.unbind('overNode');
		s.unbind('outNode');
		s.bind('overNode outNode clickNode doubleClickNode rightClickNode', function(e) {
				console.log(e.type, e.data.node.label, e.data.captor);
			});

		s.bind('overNode', function(e) {
			clicknode = e.data.node;
			var left = e['data']['node']['renderer1:x'];
			var top = e['data']['node']['renderer1:y'];
			attrs = clicknode.attributes;
			tmpstr = "";
			tmpstr += "<b>" + clicknode.label;
			tmpstr += "</b><br />";
			tmpstr += "<b>" + attrs.Name;
			tmpstr += "</b> <br />";
			tmpstr += "<img src=\"" + attrs["Image File"] + "\">";
			tmpstr += "<br />";

			tmpstr += attrs.Description;
			tmpstr += "<br />";
			tmpstr += "Location: " + attrs.Location;
			tmpstr += "<br />";
			if (attrs.Website != null) {
				tmpstr += "Website: <a href=\"" + attrs.Website + "\">" + attrs.Website + "<\a>";
				tmpstr += "<br />";
			}
			if (attrs["Joined"] != 'undefined') {
				tmpstr += "On Twitter since: " + attrs["Joined"];
				tmpstr += "<br />";
			}
			tmpstr += "Tweets: " + attrs.Tweets;
			tmpstr += "<br />";
			tmpstr += "<a href=\"\">Followed by (expand)</a>: " + attrs.Followers;
			tmpstr += "<br />";
			tmpstr += "<a href=\"\">Follows (expand)</a>: " + attrs.Followed;
			tmpstr += "<br />";
			tmpstr += "Tweets per day: 47<br />";
			tmpstr += "Shares per day: 12<br />";
			tmpstr += "% Contain: <br />";
			tmpstr += "<ul><li>Url share: 26%</li>";
			tmpstr += "<li>Mention: 5%</li>";
			tmpstr += "<li>Hashtag: 5%</li>";
			tmpstr += "<li>Ticker: 0%</li></ul>";
			tmpstr += "% by Type: <br />";
			tmpstr += "<ul><li>Tweet: 83%</li>";
			tmpstr += "<li>Retweet: 17%</li>";
			tmpstr += "<li>Quote: 0%</li></ul>";
			tmpstr += "Ticker: 0%</li></ul>";
			tmpstr += "Engagement: <br />";
			tmpstr += "<ul><li>Average # : 83%</li>";
			tmpstr += "<li>Replies: 4</li>";
			tmpstr += "<li>Retweets: 18</li>";
			tmpstr += "<li>Likes: 62</li></ul>";
			tmpstr += "Most frequent: <br />";
			tmpstr += "<ul><li>Websites : recode.com</li>";
			tmpstr += "<li>Hashtags: </li>";
			tmpstr += "<li>Tickers</li>";
			tmpstr += "<li>Users mentioned</li></ul>";
			tmpstr += "<a href=\"\">Word cloud</a><br />";
			tmpstr += "<a href=\"\">Sentiment analysis</a><br />";
			tmpstr += "<a href=\"\">Active times of day</a><br />";

			$('#popover').html(tmpstr);
			//highlightEdges(clicknode);
		});
		s.bind('clickStage', function(e) {
			});

		s.refresh();
	}

	sigma.parsers.json(
		"initial.json", 
		{container: 'graphcontainer'},
		reinit
	);
</script>
</body>
</html>


