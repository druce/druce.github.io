<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FinTwit Network Browser</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style type="text/css">
	#graphcontainer {
	  max-width: 1000px;
	  height: 800px;
	  margin: auto;
	}
	#popover {
		font-family: Arial, Helvetica, sans-serif;
		font-size: 12px;
	}
	.topiclabel {
		position:absolute;
		font-size: 24;
	}
</style></head>
<body>
	<div id="toplevel" class="container-fluid">
			<div class="row">
				<div class="col-9" id="graphcontainer">				
					</div>
				<div class="col-3">
					<div class="row">
					&nbsp; <br />
					<button class="btn btn-primary btn-sm" type="button" id="button1">Force Layout</button> &nbsp;
					<button class="btn btn-primary btn-sm" type="button" id="button2">Reset</button>
					</div>
					<div class="row">
						<div id="popover">
										</div>
					</div>	
					<div class="row">
						<form class="row form-inline">
						<div class="form-group mx-sm-2 mb-2">
							<input type="text" class="form-control" id="searchinput" placeholder="Account/Name">
							<button class="btn btn-primary btn-sm" id="searchbutton">Search</button>
						</div>
						</form>
						<div id="results">

						</div>
					</div>
				</div>
			</div>
	</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="sigma.require.js"></script>
<script src="sigma.js/plugins/sigma.parsers.json/sigma.parsers.json.js"></script>
<script src="sigma.js/plugins/sigma.layout.forceAtlas2/worker.js"></script>
<script src="sigma.js/plugins/sigma.layout.forceAtlas2/supervisor.js"></script>

<script>
	var globalsigma;
	var globalSearchResults= [];
	var globalSearchSaved= [];
	var globalEdgeSaved= [];
	var globalNodeList={};

	function populateGlobalNodes(list) {
		globalNodeList={};
		for (i=0; i< list.length; i++) {
			obj = {}
			obj["label"] = list[i].label
			globalNodeList[list[i].id] = obj;
		}
	}
	function doForce() {
		clearTopicText();
		window.globalsigma.startForceAtlas2({worker: true, barnesHutOptimize: false});
		setTimeout(function() {window.globalsigma.stopForceAtlas2(); }, 3000);
	}
	document.getElementById("button1").onclick=doForce;

	function doReinit() {
		// clear the graph nodes and edges
		s=window.globalsigma;
		s.graph.clear();
	    // remove any methods you've attached to s.
    	s.graph.kill();
		var g = document.querySelector('#graphcontainer');
	    var p = g.parentNode;
	    p.removeChild(g);
	    var c = document.createElement('div');
		c.setAttribute('id', 'graphcontainer');
		c.setAttribute('class', 'col-9');
	    p.prepend(c);		
		sigma.parsers.json("se_follow.json",
			{container: 'graphcontainer'},
			reinit
		);
	}
	document.getElementById("button2").onclick=doReinit;

	function doSearch(event) {
		event.preventDefault();
		resetSearch();
		retstr='';
		str = $('#searchinput').val();
		if (2 >= str.length) {
			$('#results').html("<i>You must search for a name with a minimum of 3 letters.</i>");
			return;
		} else {
			$('#results').html("");
		}
		globalSearchResults=[];
		str = str.toLowerCase();
		re = RegExp(str);
		nodes = globalsigma.graph.nodes()
		for (var i = 0; i < nodes.length; i++) {
			if (re.test(nodes[i].label.toLowerCase())) {
				globalSearchResults.push(nodes[i]);
				saveobj = {id: i, size: nodes[i].size, color: nodes[i].color};
				globalSearchSaved.push(saveobj);
			}
		}
		for (var i = 0; i < globalSearchResults.length; i++) {
			mynode = globalSearchResults[i];
			mynode.size=50;
			mynode.color="#000000";
		}		
		globalsigma.refresh()
	}
	document.getElementById('searchbutton').onclick=doSearch;

	function resetSearch() {
		for (i = 0; i < globalSearchSaved.length; i++) {
			savedvals = globalSearchSaved[i];
			mynode = globalsigma.graph.nodes()[savedvals.id];
			mynode.size = savedvals.size;
			mynode.color=savedvals.color
		}
		globalsigma.refresh()
		globalSearchSaved=[];
	}

	function edgesText(node) {
		node_id = node.id;
		follows = {};
		followed_by = {};
		follows_str='';
		followed_by_str='';
		both_str = '';
		
		alledges = globalsigma.graph.edges();
		for (i = 0; i < alledges.length; i++) {
			e = alledges[i];
			if (e.source == node_id)
				follows[e.target] = 1 
			if (e.target==node_id)
				followed_by[e.source] = 1 
		}
		var keys = Object.keys(followed_by);
		for (i = 0; i < keys.length; i++) {
			followed_by_id = followed_by[keys[i]];
			if(followed_by_id in follows)
				both_str += followed_by_id;
			else
				followed_by_str += followed_by_id;
		}
		for (i = 0; i < sources.length; i++) {
			e = sources[i];
			e.color='#0000cc';
			e.size=2;
			e["read_cam0:size"]=2;			
		}

		globalsigma.refresh();
	}

	function highlightEdges(node) {
		node_id = node.id;
		sources = [];
		targets = [];
		both = [];
		alledges = globalsigma.graph.edges();
		for (i = 0; i < alledges.length; i++) {
			e = alledges[i];
			if (e.source == node_id)
				sources.push(e)
			if (e.target==node_id)
				targets.push(e)
		}
		for (i = 0; i < both.length; i++) {
			e = both[i];
			e.color='#cc0000';
			e.size=2;
			e["read_cam0:size"]=2;			
		}
		for (i = 0; i < targets.length; i++) {
			e = targets[i];
			e.color='#00cc00';
			e.size=2;
			e["read_cam0:size"]=2;			
		}
		for (i = 0; i < sources.length; i++) {
			e = sources[i];
			e.color='#0000cc';
			e.size=2;
			e["read_cam0:size"]=2;			
		}

		globalsigma.refresh();
	}

	function clearTopicText() {
		var p = document.getElementsByClassName('topiclabel');
		while(p[0]) {
			p[0].parentNode.removeChild(p[0]);
		}
		p = document.getElementsByClassName('topics');
		while(p[0]) {
			p[0].parentNode.removeChild(p[0]);
		}
	}

	function topicText() {
		var p = document.querySelector('#toplevel');
		var c = document.createElement('div');
		c.setAttribute('class', 'topics');

		htmlstr = "<div class=\"topiclabel\"  style=\"left:525px; top:275px;\">US Markets</div>";
//		htmlstr += "<div class=\"topiclabel\"  style=\"left:575px; top:200px;\">Macro Maestros</div>";
//		htmlstr += "<div class=\"topiclabel\"  style=\"left:650px; top:270px;\">Policy Mavens</div>";
		htmlstr += "<div class=\"topiclabel\"  style=\"left:650px; top:450px;\">Europe</div>";
		htmlstr += "<div class=\"topiclabel\"  style=\"left:560px; top:550px;\">Tech</div>";
		htmlstr += "<div class=\"topiclabel\"  style=\"left:475px; top:540px;\">Macro/Fed</div>";
//		htmlstr += "<div class=\"topiclabel\"  style=\"left:375px; top:400px;\">US Equity Sharks</div>";
		htmlstr += "<div class=\"topiclabel\"  style=\"left:425px; top:350px;\">US Policy</div>";
		
		c.innerHTML=htmlstr;
		p.prepend(c);
	}

	function doExpandFollows(node) {
		alert('expand followers ' + node);
	}

	function doExpandFollowed(node) {
		alert('expand followed ' + node);
		retstr = "<br \>";
		alledges = globalsigma.graph.edges();
		for (i = 0; i < alledges.length; i++) {		
			e = alledges[i];
			if (e.target == node) {
				retstr += globalNodeList[e.source].label;
				retstr += "<br />"
			}
		}
		//retstr += "<br \>";
		var p = document.querySelector('#followed');
		p.innerHTML=retstr;


	}

	function reinit (s) {
		window.globalsigma=s;
		s.settings('verbose', true);
		s.settings('defaultEdgeColor', '#ccc');
//		s.settings('defaultNodeColor', '#903');
		s.settings('defaultLabelSize', '10');
		s.settings('maxNodeSize', 4);
		s.settings('minEdgeSize', 0.0);
		s.settings('maxEdgeSize', 1);
		s.settings('labelThreshold', 0);
//		s.settings('defaultLabelColor', '#900');
//		s.settings('defaultLabelBGColor', '#ddd');
		s.settings('drawNodes', true);
		s.settings('drawEdges', false);
		s.settings('batchEdgesDrawing', true);
		s.settings('labelColor', 'node');
		s.settings('edgeColor', '#FFFFFF');
		s.settings('zoomMin', 0.3);
		s.settings('zoomMax', 3);
				
		s.bind('clickNode', function(event) { console.log(event); } );
		s.unbind('overNode');
		s.unbind('outNode');
		s.bind('overNode outNode clickNode doubleClickNode rightClickNode', function(e) {
				console.log(e.type, e.data.node.label, e.data.captor);
			});

		s.bind('overNode', function(e) {
			clicknode = e.data.node;
			var left = e['data']['node']['renderer1:x'];
			var top = e['data']['node']['renderer1:y'];
			attrs = clicknode.attributes;
			tmpstr = "";
			tmpstr += "<b><a href=\"https://twitter.com/" + clicknode.label + "\" target=\"_blank\" title=\"Follow on Twitter\">" + clicknode.label + "</a>";
			tmpstr += " <a href=\"https://twitter.com/intent/follow?original_referer=http%3A%2F%2Fwww.streeteye.com%2Fleaderboard&amp;region=follow_link&amp;screen_name=" + clicknode.label + "&amp;source=followbutton&amp;variant=2.0\" target=\"_blank\" title=\"Follow on Twitter\"><img src=\"twitter-bird-16x16.png\" width=16 height=16 class=\"tbirdie\" alt=\"follow\"></a></td>"
			tmpstr += "</b><br />";
			tmpstr += "<b>" + attrs.Name;
			tmpstr += "</b> <br />";
			tmpstr += "<img src=\"" + attrs["Image File"] + "\">";
			tmpstr += "<br />";

			tmpstr += attrs.Description;
			tmpstr += "<br />";
			tmpstr += "Location: " + attrs.Location;
			tmpstr += "<br />";
			if (attrs.Website != null) {
				tmpstr += "Website: <a href=\"" + attrs.Website + "\">" + attrs.Website + "<\a>";
				tmpstr += "<br />";
			}
			if (attrs["Joined"] != 'undefined') {
				tmpstr += "On Twitter since: " + attrs["Joined"];
				tmpstr += "<br />";
			}
			tmpstr += "&nbsp; <br />";
			tmpstr += "Tweets: " + attrs.Tweets;
			tmpstr += "<br />";
			tmpstr += "Followed by: " + attrs.Followers ;
			// <a onclick=\"javascript:doExpandFollowed('"+clicknode.id+"');\">(expand)</a>";
			// too many inline + moves canvas
			// put in hidden div, unhide, lick to hide
			tmpstr += "<span id=\"followed\"></span>"
			// eventually - create a span or div here
			// click - populate span by looping through all edges
			// lick to reset span
			tmpstr += "<br />";
			tmpstr += "Follows: " + attrs.Followed 
			//+ " <a href=\"\">(expand)</a>";
			tmpstr += "<span id=\"follows\"></span>"
			tmpstr += "<br />";
			tmpstr += "Tweets per day: " + attrs.tweets_per_day +  "<br /> &nbsp; <br />";
			tmpstr += "% Contain: <br />"; 
			tmpstr += "<ul><li>Url share: " + attrs.urls_pct + "%</li>";
			tmpstr += "<li>Mention: " + attrs.media_pct + "%</li>";
			tmpstr += "<li>Hashtag: " + attrs.hashtag_pct + "%</li>";
			tmpstr += "<li>Ticker: " + attrs.symbol_pct + "%</li></ul>";
//			tmpstr += "Most frequent: <br />";
//			tmpstr += "<ul><li>Websites : recode.com</li>";
//			tmpstr += "<li>Hashtags: </li>";
//			tmpstr += "<li>Tickers</li>";
//			tmpstr += "<li>Users mentioned</li></ul>";

			tmpstr += "% by Type (Retweet/Quote/Reply): "+ attrs.retweet_pct + "% / "+ attrs.quote_pct + "% / "+ attrs.reply_pct + "% <br /> &nbsp; <br />";
			tmpstr += "Engagement per tweet (Avg): <br />";
//			tmpstr += "<ul><li>Replies: "+ attrs.replies_per_tweet + "</li>";
			tmpstr += "<ul><li>Retweets: "+ attrs.retweet_per_tweet + "</li>";
			tmpstr += "<li>Likes: "+ attrs.favorite_per_tweet + "</li></ul>";

			$('#popover').html(tmpstr);
			//highlightEdges(clicknode);
		});
		s.bind('clickStage', function(e) {
			});

		s.refresh();
		topicText();
		populateGlobalNodes(globalsigma.graph.nodes());
	}

	sigma.parsers.json(
		"se_follow.json", 
		{container: 'graphcontainer'},
		reinit
	);
</script>
</body>
</html>


