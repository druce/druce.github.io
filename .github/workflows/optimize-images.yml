name: Optimize Images

on:
  push:
    paths:
      - 'assets/**/*.png'
      - 'assets/**/*.jpg'
      - 'assets/**/*.jpeg'
    branches:
      - master

jobs:
  optimize:
    # Only run if not already optimized (to prevent loops)
    if: "!contains(github.event.head_commit.message, '[skip-img]')"

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Optimize images
        uses: calibreapp/image-actions@main
        with:
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          # Compression quality (0-100, higher = better quality but larger file)
          jpegQuality: 85
          pngQuality: 85
          webpQuality: 85
          # Set to true to also create WebP versions
          ignoredFiles: 'assets/wp-content/**'
          # Commit optimized images back
          compressOnly: false

      - name: Create pull request (optional)
        if: steps.optimize.outputs.markdown != ''
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'Optimize images [skip-img]'
          commit-message: 'Optimize images [skip-img]'
          branch: optimize-images
          delete-branch: true
          body: |
            ## Image Optimization Results

            ${{ steps.optimize.outputs.markdown }}

            Automated image optimization via GitHub Actions.
